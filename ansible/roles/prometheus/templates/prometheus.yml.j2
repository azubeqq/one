# --- roles/prometheus/templates/prometheus.yml.j2 ---
global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    monitor: 'prometheus-server'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['{{ alertmanager_container_name }}:9093']

rule_files:
  - '/etc/prometheus/alerts/*.yml'

scrape_configs:
{% for target in prometheus_static_targets %}
  - job_name: '{{ target.job_name }}'
{% if target.metrics_path is defined %}
    metrics_path: '{{ target.metrics_path }}'
{% endif %}
    static_configs:
      - targets: {{ target.targets | to_json }}
{% if target.labels is defined %}
        labels:
{% for key, value in target.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}

{% if prometheus_docker_sd_enabled %}
  # ----------------------------------------
  # Docker Service Discovery
  # ----------------------------------------
  - job_name: 'docker-containers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
    
    relabel_configs:
      # 1. Имя контейнера (убираем ведущий слэш)
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'
        replacement: '$1'
      
      # 2. Docker image
      - source_labels: ['__meta_docker_container_image']
        target_label: 'image'
      
      # 3. Compose service name (если есть)
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'
      
      # 4. Compose project (если есть)
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'compose_project'
      
      # 5. Container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'
        regex: '(.{12}).*'
        replacement: '$1'
      
      # 6. Сеть контейнера
      - source_labels: ['__meta_docker_network_name']
        target_label: 'network'
      
      # 7. ВАЖНО: Оставляем только running контейнеры
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        action: keep
        regex: '.+'
      
      # 8. КРИТИЧНО: Формируем правильный адрес для скрапинга
      # Используем имя контейнера + первый экспонированный порт
      - source_labels: ['__meta_docker_container_name', '__meta_docker_port_private']
        regex: '/(.*);(\d+)'
        target_label: '__address__'
        replacement: '$1:$2'
      
      # 9. Сохраняем оригинальный порт
      - source_labels: ['__meta_docker_port_private']
        target_label: 'port'
      
      # 10. Instance = container name (для дашборда)
      - source_labels: ['container_name']
        target_label: 'instance'
{% endif %}
