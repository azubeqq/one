# --- roles/prometheus/templates/prometheus.yml.j2 ---
global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    monitor: 'prometheus-server'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['{{ alertmanager_container_name }}:9093']

rule_files:
  - '/etc/prometheus/alerts/*.yml'

scrape_configs:
{% for target in prometheus_static_targets %}
  - job_name: '{{ target.job_name }}'
{% if target.metrics_path is defined %}
    metrics_path: '{{ target.metrics_path }}'
{% endif %}
    static_configs:
      - targets: {{ target.targets | to_json }}
{% if target.labels is defined %}
        labels:
{% for key, value in target.labels.items() %}
          {{ key }}: '{{ value }}'
{% endfor %}
{% endif %}
{% endfor %}

{% if prometheus_docker_sd_enabled %}
  # ----------------------------------------
  # Docker Service Discovery
  # ----------------------------------------
  - job_name: 'docker-containers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 30s
    
    relabel_configs:
      # Имя контейнера
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'
        replacement: '$1'

      # Docker image
      - source_labels: ['__meta_docker_container_image']
        target_label: 'container_image'

      # Статус контейнера
      - source_labels: ['__meta_docker_container_status']
        target_label: 'container_status'

      # Сеть контейнера
      - source_labels: ['__meta_docker_network_name']
        target_label: 'docker_network'

      # --- KEEP только помеченные контейнеры ---
      # Оставляем только контейнеры с label prometheus.scrape=false
      - source_labels: ['__meta_docker_container_label_prometheus_scrape']
        regex: 'true'
        action: keep

      # --- Формируем __address__ ---
      # Первый вариант: если есть label prometheus.metrics_port, используем его
      - source_labels: ['__meta_docker_container_network_ip', '__meta_docker_container_label_prometheus_metrics_port']
        regex: '([^;]+);(.+)'
        replacement: '$1:$2'
        target_label: '__address__'

      # Fallback: используем первый приватный порт контейнера (текущая логика)
      - source_labels: ['__meta_docker_container_network_ip', '__meta_docker_port_private']
        regex: '([^;]+);(.+)'
        replacement: '$1:$2'
        target_label: '__address__'

      # Пропускаем контейнеры без адреса/порта (как раньше)
      - source_labels: ['__address__']
        regex: '.+'
        action: keep

{% endif %}
