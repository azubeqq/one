# ========================================
# РОЛЬ: prometheus
# Система мониторинга и сбора метрик
# ========================================

# --- roles/prometheus/defaults/main.yml ---
---
# Директория для Prometheus
prometheus_dir: "{{ base_dir }}/prometheus"

# Docker образ
prometheus_image: "prom/prometheus:v2.48.0"

# Имя контейнера
prometheus_container_name: "prometheus"

# Порт веб-интерфейса
prometheus_port: 9090

# Volume для хранения метрик
prometheus_volume_name: "prometheus_data"

# Настройки хранения данных
prometheus_retention_time: "15d"    # Хранить метрики 15 дней
prometheus_retention_size: "10GB"   # Максимальный размер данных

# Интервал сбора метрик (глобальный)
prometheus_scrape_interval: "15s"

# Интервал вычисления rules
prometheus_evaluation_interval: "15s"

# Включить Docker Service Discovery
# Prometheus будет автоматически находить контейнеры
prometheus_docker_sd_enabled: true

# Порт Docker metrics (из роли docker)
prometheus_docker_metrics_port: 9323

# Имя контейнера Алертинга
alertmanager_container_name: "alertmanager"

# Targets для скрапинга
# Определяем все сервисы которые хотим мониторить
prometheus_static_targets:
  # Сам Prometheus
  - job_name: "prometheus"
    targets: ["localhost:9090"]
    labels:
      service: "prometheus"
  
  # Flask приложение (с встроенными метриками)
  - job_name: "flask"
    targets: ["{{ flask_container_name }}:5000"]
    metrics_path: "/metrics"
    labels:
      service: "flask"
      app: "web"
  
  # Node Exporter (метрики хоста)
  - job_name: "node_exporter"
    targets: ["{{ node_exporter_container_name }}:9100"]
    labels:
      service: "node_exporter"
  
  # PostgreSQL Exporter
  - job_name: "postgres_exporter"
    targets: ["{{ postgres_exporter_container_name }}:9187"]
    labels:
      service: "postgres_exporter"
      database: "postgres"
  
  # Alertmanager
  - job_name: "alertmanager"
    targets: ["{{ alertmanager_container_name }}:9093"]
    labels:
      service: "alertmanager"
  
  # Loki (логи)
  - job_name: "loki"
    targets: ["{{ loki_container_name }}:3100"]
    labels:
      service: "loki"
  
  # Docker Engine metrics
  - job_name: "docker"
    targets: ["host.docker.internal:{{ prometheus_docker_metrics_port }}"]
    labels:
      service: "docker"

  # cAdvisor (метрики контейнеров: CPU, RAM, Network, Disk I/O)
  - job_name: "cadvisor"
    targets: ["{{ cadvisor_container_name }}:8080"]
    labels:
      service: "cadvisor"